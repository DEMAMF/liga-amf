<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMF - Sistema Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { border-bottom: 4px solid #1e3a8a; color: #1e3a8a; background-color: #eff6ff; }
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        .team-logo { width: 30px; height: 30px; object-fit: contain; }
        .loading-overlay { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
    </style>
</head>
<body class="min-h-screen text-slate-900">

    <!-- Pantalla de Carga -->
    <div id="loader" class="loading-overlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-900 border-solid mx-auto mb-4"></div>
            <p class="font-black uppercase italic text-slate-400 animate-pulse">Conectando con la Nube...</p>
        </div>
    </div>

    <div class="max-w-5xl mx-auto md:my-10 bg-white md:rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200 min-h-[80vh]">
        
        <!-- HEADER -->
        <header class="bg-slate-900 p-8 text-white flex flex-col md:flex-row justify-between items-center gap-6 relative">
            <button onclick="toggleAdmin()" class="absolute top-4 right-4 text-white/10 hover:text-blue-400 p-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
            </button>

            <div class="flex items-center gap-5">
                <div class="text-left uppercase">
                    <h1 class="text-2xl font-black italic leading-tight">AMF - OFICIAL</h1>
                    <h2 class="text-blue-400 font-bold text-sm italic">Dto. de FUTSAL MAYOR</h2>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="exportarPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase transition-all shadow-lg flex items-center gap-2">
                    Exportar PDF
                </button>
            </div>
        </header>

        <!-- MENU -->
        <nav class="flex border-b border-slate-100 bg-white sticky top-0 z-10">
            <button onclick="showTab('equipos')" id="btn-equipos" class="tab-button active flex-1 px-4 py-4 font-black text-[10px] uppercase tracking-tighter">Clubes</button>
            <button onclick="showTab('partidos')" id="btn-partidos" class="tab-button flex-1 px-4 py-4 font-black text-[10px] uppercase tracking-tighter">Resultados</button>
            <button onclick="showTab('tabla')" id="btn-tabla" class="tab-button flex-1 px-4 py-4 font-black text-[10px] uppercase tracking-tighter">Posiciones</button>
            <button onclick="showTab('general')" id="btn-general" class="tab-button flex-1 px-4 py-4 font-black text-[10px] uppercase tracking-tighter">General</button>
        </nav>

        <main class="p-6">
            <!-- PANEL CLUBES -->
            <div id="equipos" class="tab-content active">
                <div class="admin-only mb-6 bg-slate-50 p-4 rounded-xl border-2 border-dashed border-slate-200">
                    <div class="flex gap-2">
                        <input type="text" id="new-team-name" placeholder="NOMBRE DEL CLUB..." class="flex-1 p-3 rounded-lg font-bold uppercase border border-slate-300">
                        <button onclick="addTeam()" class="bg-blue-600 text-white px-6 rounded-lg font-black uppercase text-xs">Añadir</button>
                    </div>
                </div>
                <div id="team-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>

            <!-- PANEL RESULTADOS -->
            <div id="partidos" class="tab-content">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-black text-slate-800 uppercase italic">Partidos Cargados</h2>
                    <div class="flex gap-2 admin-only">
                        <input type="file" id="excel-import" class="hidden" onchange="importFixture(event)">
                        <button onclick="document.getElementById('excel-import').click()" class="bg-green-600 text-white px-3 py-2 rounded font-bold text-[10px] uppercase">Excel</button>
                        <button onclick="resetGeneralData()" class="bg-red-600 text-white px-3 py-2 rounded font-bold text-[10px] uppercase">Borrar Todo</button>
                    </div>
                </div>

                <div class="admin-only bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                        <select id="m-category" class="p-2 rounded font-bold text-[10px] uppercase border">
                            <option value="1º DIVISION">1º DIVISION</option>
                            <option value="3º DIVISION">3º DIVISION</option>
                            <option value="4º DIVISION">4º DIVISION</option>
                            <option value="5º DIVISION">5º DIVISION</option>
                            <option value="6º DIVISION">6º DIVISION</option>
                            <option value="1º DIVISION FEMENINIO">1º DIVISION FEMENINIO</option>
                            <option value="SENIOR">SENIOR</option>
                        </select>
                        <input type="text" id="m-round" placeholder="FECHA 1" class="p-2 rounded font-bold text-[10px] uppercase border">
                        <input type="text" id="m-tour" value="TORNEO OFICIAL" class="p-2 rounded font-bold text-[10px] uppercase border">
                    </div>
                    <div class="flex items-center gap-2 bg-white p-4 rounded border">
                        <select id="m-local" class="flex-1 p-2 font-bold uppercase border text-[10px]"></select>
                        <input type="number" id="g-local" placeholder="0" class="w-12 text-center font-black bg-slate-100 border p-2">
                        <span class="font-black italic text-slate-400">VS</span>
                        <input type="number" id="g-visitor" placeholder="0" class="w-12 text-center font-black bg-slate-100 border p-2">
                        <select id="m-visitor" class="flex-1 p-2 font-bold uppercase border text-[10px]"></select>
                    </div>
                    <button onclick="addMatch()" class="w-full mt-3 bg-blue-600 text-white py-3 rounded-lg font-black uppercase text-[10px]">Guardar</button>
                </div>

                <div id="match-list" class="space-y-3"></div>
            </div>

            <!-- PANEL POSICIONES -->
            <div id="tabla" class="tab-content">
                <select id="filter-category-table" onchange="updateStandingsUI()" class="w-full mb-4 bg-slate-900 text-white p-3 rounded-lg font-bold text-xs uppercase">
                    <option value="1º DIVISION">1º DIVISION</option>
                    <option value="3º DIVISION">3º DIVISION</option>
                    <option value="4º DIVISION">4º DIVISION</option>
                    <option value="5º DIVISION">5º DIVISION</option>
                    <option value="6º DIVISION">6º DIVISION</option>
                    <option value="1º DIVISION FEMENINIO">1º DIVISION FEMENINIO</option>
                    <option value="SENIOR">SENIOR</option>
                </select>
                <div class="overflow-x-auto rounded-xl border border-slate-200">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-900 text-white uppercase text-[9px]">
                            <tr>
                                <th class="p-3 text-center">Pos</th>
                                <th class="p-3">Club</th>
                                <th class="p-2 text-center">PJ</th>
                                <th class="p-2 text-center">DG</th>
                                <th class="p-3 text-center bg-blue-800">PTS</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body" class="divide-y font-bold"></tbody>
                    </table>
                </div>
            </div>

            <!-- PANEL GENERAL -->
            <div id="general" class="tab-content">
                <div class="overflow-hidden rounded-xl border border-slate-200">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-900 text-white uppercase text-[9px]">
                            <tr>
                                <th class="p-4 text-center w-16">Pos</th>
                                <th class="p-4">Club</th>
                                <th class="p-4 text-center bg-blue-800">Total Puntos</th>
                            </tr>
                        </thead>
                        <tbody id="general-standings-body" class="divide-y font-bold italic"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Script de Depuración -->
    <div id="debug-log" class="max-w-5xl mx-auto mt-4 p-4 bg-black text-green-500 font-mono text-[10px] rounded h-32 overflow-y-auto hidden">
        > Iniciando sistema...
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const log = (msg) => {
            const d = document.getElementById('debug-log');
            d.innerHTML += `<br>> ${msg}`;
            console.log(msg);
        };

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // REGLA DE ORO: Ruta absoluta controlada
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'amf-prod-v1';
        const PUBLIC_PATH = ['artifacts', APP_ID, 'public', 'data'];

        let teams = [];
        let matches = [];
        let user = null;
        let isAdmin = false;

        // AUTH
        const init = async () => {
            try {
                log("Autenticando...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                log("ERROR AUTH: " + e.message);
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                log("Sesión activa: " + u.uid);
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                startListeners();
            }
        });

        const startListeners = () => {
            if (!user) return;
            log("Iniciando escucha de datos...");

            // Colecciones
            const teamsRef = collection(db, ...PUBLIC_PATH, 'teams');
            const matchesRef = collection(db, ...PUBLIC_PATH, 'matches');

            onSnapshot(teamsRef, (snap) => {
                teams = snap.docs.map(d => d.data().name);
                log(`Equipos recibidos: ${teams.length}`);
                renderTeams();
                updateSelects();
                updateStandingsUI();
                updateGeneralUI();
            }, (err) => log("Error Equipos: " + err.message));

            onSnapshot(matchesRef, (snap) => {
                matches = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                log(`Resultados recibidos: ${matches.length}`);
                renderMatches();
                updateStandingsUI();
                updateGeneralUI();
            }, (err) => log("Error Resultados: " + err.message));
        };

        // ACCIONES GLOBALES
        window.toggleAdmin = () => {
            const p = prompt("Password:");
            if(p === "1234") {
                isAdmin = !isAdmin;
                document.body.classList.toggle('is-admin', isAdmin);
                document.getElementById('debug-log').classList.toggle('hidden', !isAdmin);
                log("Modo Admin: " + isAdmin);
            }
        };

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-'+id).classList.add('active');
        };

        window.addTeam = async () => {
            const n = document.getElementById('new-team-name').value.trim().toUpperCase();
            if(n && !teams.includes(n)) {
                await setDoc(doc(db, ...PUBLIC_PATH, 'teams', n), { name: n });
                document.getElementById('new-team-name').value = '';
            }
        };

        window.addMatch = async () => {
            const m = {
                category: document.getElementById('m-category').value,
                round: document.getElementById('m-round').value.toUpperCase() || 'FECHA',
                tour: document.getElementById('m-tour').value.toUpperCase(),
                local: document.getElementById('m-local').value,
                visitor: document.getElementById('m-visitor').value,
                gL: document.getElementById('g-local').value === "" ? null : parseInt(document.getElementById('g-local').value),
                gV: document.getElementById('g-visitor').value === "" ? null : parseInt(document.getElementById('g-visitor').value),
                ts: Date.now()
            };
            if(m.local === m.visitor) return;
            await addDoc(collection(db, ...PUBLIC_PATH, 'matches'), m);
            document.getElementById('g-local').value = '';
            document.getElementById('g-visitor').value = '';
        };

        window.deleteMatch = async (id) => {
            if(confirm("¿Borrar?")) await deleteDoc(doc(db, ...PUBLIC_PATH, 'matches', id));
        };

        // RENDERERS
        const renderTeams = () => {
            const grid = document.getElementById('team-grid');
            grid.innerHTML = teams.sort().map(t => `
                <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                    <span class="font-black text-[10px] uppercase italic">${t}</span>
                    ${isAdmin ? `<button onclick="deleteDoc(doc(db, ...PUBLIC_PATH, 'teams', '${t}'))" class="text-red-500">x</button>` : ''}
                </div>
            `).join('');
        };

        window.renderMatches = () => {
            document.getElementById('match-list').innerHTML = matches.sort((a,b) => b.ts - a.ts).map(m => `
                <div class="bg-white p-3 rounded-lg border border-l-4 border-l-slate-900 flex items-center justify-between text-[10px] font-bold">
                    <div class="w-20 text-slate-400 uppercase">${m.category}</div>
                    <div class="flex-1 text-right italic uppercase">${m.local}</div>
                    <div class="flex gap-1 mx-3">
                        <div class="bg-slate-900 text-white w-8 h-8 flex items-center justify-center rounded">${m.gL ?? '-'}</div>
                        <div class="bg-slate-900 text-white w-8 h-8 flex items-center justify-center rounded">${m.gV ?? '-'}</div>
                    </div>
                    <div class="flex-1 text-left italic uppercase">${m.visitor}</div>
                    ${isAdmin ? `<button onclick="deleteMatch('${m.id}')" class="ml-2 text-red-500">×</button>` : ''}
                </div>
            `).join('');
        };

        const updateSelects = () => {
            const h = teams.sort().map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('m-local').innerHTML = h;
            document.getElementById('m-visitor').innerHTML = h;
        };

        window.updateStandingsUI = () => {
            const cat = document.getElementById('filter-category-table').value;
            const stats = {};
            teams.forEach(t => stats[t] = { pts:0, pj:0, dg:0 });
            matches.filter(m => m.category === cat && m.gL !== null).forEach(m => {
                if(!stats[m.local] || !stats[m.visitor]) return;
                stats[m.local].pj++; stats[m.visitor].pj++;
                stats[m.local].dg += (m.gL - m.gV); stats[m.visitor].dg += (m.gV - m.gL);
                if(m.gL > m.gV) stats[m.local].pts += 3;
                else if(m.gV > m.gL) stats[m.visitor].pts += 3;
                else { stats[m.local].pts++; stats[m.visitor].pts++; }
            });
            const sorted = Object.entries(stats).sort((a,b) => b[1].pts - a[1].pts || b[1].dg - a[1].dg);
            document.getElementById('standings-body').innerHTML = sorted.map(([name, s], i) => `
                <tr>
                    <td class="p-3 text-center">${i+1}</td>
                    <td class="p-3 uppercase italic">${name}</td>
                    <td class="p-2 text-center text-slate-400">${s.pj}</td>
                    <td class="p-2 text-center">${s.dg}</td>
                    <td class="p-3 text-center bg-blue-50 text-blue-900 font-black">${s.pts}</td>
                </tr>
            `).join('');
        };

        window.updateGeneralUI = () => {
            const gen = {};
            teams.forEach(t => gen[t] = 0);
            matches.filter(m => m.gL !== null).forEach(m => {
                if(gen[m.local] === undefined) return;
                if(m.gL > m.gV) gen[m.local] += 3;
                else if(m.gV > m.gL) gen[m.visitor] += 3;
                else { gen[m.local]++; gen[m.visitor]++; }
            });
            const sorted = Object.entries(gen).sort((a,b) => b[1] - a[1]);
            document.getElementById('general-standings-body').innerHTML = sorted.map(([name, pts], i) => `
                <tr class="bg-white">
                    <td class="p-4 text-center text-slate-400 font-black">${i+1}</td>
                    <td class="p-4 uppercase">${name}</td>
                    <td class="p-4 text-center bg-blue-900 text-white font-black text-lg">${pts}</td>
                </tr>
            `).join('');
        };

        init();
    </script>
</body>
</html>
